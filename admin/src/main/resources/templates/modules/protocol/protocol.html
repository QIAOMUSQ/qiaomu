<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>维修信息</title>
    <#include "/header.html">

    <link rel="stylesheet" href="${request.contextPath}/statics/plugins/layui/css/layui.css">
    <style>
        ::-webkit-scrollbar {
            display: none;
        }

    </style>
</head>
<body>
<div id="rrapp" v-cloak>
    <div v-show="showList">
        <div class="grid-btn">
            <div class="form-group col-sm-2">
                <input type="text" class="form-control"  v-model="q.title" @keyup.enter="query"  id= "title" placeholder="协议名称">
            </div>
            <a class="btn btn-primary" @click="add"><i class="fa fa-plus"></i>&nbsp;新增</a>
            <a class="btn btn-primary" @click="update"><i class="fa fa-pencil-square-o"></i>&nbsp;修改</a>
            <a class="btn btn-primary" @click="del"><i class="fa fa-trash-o"></i>&nbsp;删除</a>
            <a class="btn btn-default" @click="query" >查询</a>
        </div>
        <table id="jqGrid"></table>
        <div id="jqGridPager"></div>
    </div>
    <div v-show="!showList" class="panel panel-default">
        <div class="panel-heading">{{operate}}</div>
        <form class="form-horizontal">
            <div class="form-group">
                <div class="col-sm-2 control-label">协议名称</div>
                <div class="col-sm-10">
                    <input type="text" class="form-control" v-model="protocol.title" placeholder="协议名称"/>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-2 control-label">协议内容</div>
                <div class="col-sm-10">
                    <div id="content"  class="layui-col-md12"  v-model="protocol.content" ></div>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-2 control-label"></div>
                <input type="button" class="btn btn-primary" @click="saveOrUpdate" value="确定"/>
                &nbsp;&nbsp;<input type="button" class="btn btn-warning" @click="reload" value="返回"/>
            </div>
        </form>
    </div>

</div>



</body>
<script src="${request.contextPath}/statics/plugins/layui/layui.js"></script>
<script src="${request.contextPath}/statics/plugins/wangEditor/wangEditor.js" type="text/javascript"></script>
<script>
    var rate = layui.rate; let editor2;
    $(function () {
        page()
        vm.loadEdit();
    });


    var vm = new Vue({
        el:'#rrapp',
        data:{
            q:{
                title: null
            },
            showList: true,
            operate:null,
            protocol:{
                title:null,
                content:null
            }
        },
        methods: {
            query: function () {
                vm.reload();
            },
            add: function(){
                vm.showList = false;
                vm.operate = "新增";
                vm.protocol={title:null, content:null};
                editor2.txt.html("");
            },

            update: function () {
                var id = getSelectedRow();
                if(id == null){
                    return ;
                }

                vm.showList = false;
                vm.operate = "修改";
                vm.getProtocol(id);

            },
            del: function () {
                var ids = getSelectedRows();
                if(ids == null){
                    return ;
                }

                confirm('确定要删除选中的记录？', function(){
                    $.ajax({
                        type: "POST",
                        url: baseURL + "protocol/delete",
                        contentType: "application/json",
                        data: JSON.stringify(ids),
                        success: function(r){
                            if(r.status == "success"){
                                alert('操作成功', function(){
                                    vm.reload();
                                });
                            }else{
                                alert(r.msg);
                            }
                        }
                    });
                });
            },
            saveOrUpdate: function () {
                let html = editor2.txt.html();
                vm.protocol.content=html;
                let url = vm.protocol.id == null ? "protocol/save" : "protocol/update";
                console.info(JSON.stringify(vm.protocol))
                $.ajax({
                    type: "POST",
                    url: baseURL + url,
                    contentType: "application/json;charset=UTF-8",
                    dataType : 'json',
                    data: JSON.stringify(vm.protocol),
                    success: function(r){
                        console.info(r);
                        if(r.status == "success"){
                            alert('操作成功', function(){
                                vm.reload();
                            });
                        }else{
                            alert(r.respMsg);
                        }
                    }
                });
            },
            getProtocol: function(id){
                $.get(baseURL + "protocol/info/"+id, function(result){
                    editor2.txt.html(result.protocol.content);
                    vm.protocol.title=result.protocol.title;
                    vm.protocol.id = result.protocol.id;
                });
            },
            reload: function () {
                vm.showList = true;
                var page = $("#jqGrid").jqGrid('getGridParam','page');
                $("#jqGrid").jqGrid('setGridParam',{
                    postData:{'title': vm.q.title},
                    page:page
                }).trigger("reloadGrid");
            },
            loadEdit:function () {
                var E = window.wangEditor;
                editor2 = new E('#content');
                // 自定义菜单配置
                editor2.customConfig.menus = [
                    'head',  // 标题
                    'bold',  // 粗体
                    'fontSize',  // 字号
                    'fontName',  // 字体
                    'italic',  // 斜体
                    'underline',  // 下划线
                    'foreColor',  // 文字颜色
                    'backColor',  // 背景颜色
                    'justify'  // 对齐方式
                ]
                editor2.create();
            }
        }
    });

    function page() {
        $("#jqGrid").jqGrid({
            url: baseURL + 'protocol/queryPage',
            datatype: "json",
            mtype:"POST",
            colModel: [
                { label: 'id', name: 'id', index: "id", width: 45, key: true,hidden:true },
                { label: '标题', name: 'title', align:'center', width: 85 },
                { label: '创建时间', name: 'createTime',align:'center', width: 100 },
                { label: '内容', name: 'content',align:'center', width: 100 }
            ],
            viewrecords: true,
            height: 385,
            rowNum: 10,
            rowList : [10,30,50],
            rownumbers: true,
            rownumWidth: 25,
            autowidth:true,
            multiselect: true,
            pager: "#jqGridPager",
            jsonReader : {
                root: "page.list",
                page: "page.currPage",
                total: "page.totalPage",
                records: "page.totalCount"
            },
            prmNames : {
                page:"page",
                rows:"limit",
                order: "order"
            },
            gridComplete:function(){
                //隐藏grid底部滚动条
                $("#jqGrid").closest(".ui-jqgrid-bdiv").css({ "overflow-x" : "hidden" });
            }
        });
    }




</script>

</html>