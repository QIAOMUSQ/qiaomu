<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <#include "/header.html">
        <link rel="stylesheet" href="${request.contextPath}/statics/plugins/layui/css/layui.css">
        <style>
            ::-webkit-scrollbar{width:0px;height:0px;}
            .layadmin-backlog .layadmin-backlog-body {
                display: block;
                padding: 10px 15px;
                background-color: #f8f8f8;
                color: #999;
                border-radius: 2px;
                transition: all .3s;
                -webkit-transition: all .3s;
                height: 125px;
            }
            .layadmin-backlog-body h3 {
                padding-bottom: 10px;
                font-size: 21px;
                color: #009688;
                font-weight: 300;
            }
            .layadmin-backlog-body p cite {
                font-style: normal;
                font-size: 16px;
                color: #000;
            }
            .layui-col-xs4{
                padding: 20px;
            }
            .layui-form-label{
                width: 90px;
            }

        </style>
</head>
<body>
    <div class="layui-card layadmin-backlog" id="companyText">
        <div class="layui-card-header">
            <h2 style="text-align: center; margin: 10px;font-size: 41px;" id="companyNames"> </h2>
        </div>
        <div class="layui-card-body">
            <ul class="layui-row layui-col-space10 layui-this" id="communityContent">
            </ul>
        </div>
    </div>
    <div class="layui-card" id="communityText" style="display: none;">
        <div class="layui-card-header">
            <div class="layui-a-tips">
                <h2 id="communityName" style="text-align: center; margin: 10px;font-size: 41px;"> </h2>
                <div class="layui-col-sm1" style="float: right;margin-top: -65px;">
                    <button class="layui-btn layui-btn-danger" onclick="calBack();">返回</button>
                </div>
            </div>
        </div>
        <div class="layui-card-body">
            <div class="layui-col-sm2">
                <blockquote class="layui-elem-quote" id="communityHouse">小区户数:-</blockquote>
            </div>
            <div class="layui-col-sm2">
                <blockquote class="layui-elem-quote" id="loginTimes">登录次数:-</blockquote>
            </div>
            <div class="layui-col-sm2">
                <blockquote class="layui-elem-quote" >物业缴费占比:-</blockquote>
                <input style="display: none" id="communityId"/>
            </div>
            <div class="layui-col-sm6">
                <div class="layui-inline">
                    <label class="layui-form-label">开始时间</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" id="startTime" placeholder="yyyy-MM-dd" lay-key="1">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">结束时间</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" id="endTime" placeholder="yyyy-MM-dd" lay-key="2">
                    </div>
                </div>
            </div>

            <div class="layui-row layui-col-space10">
                <div class="layui-col-md5">
                    <div class="layui-card">
                        <div class="layui-card-header">维修板块</div>
                        <div class="layui-card-body">
                            <ul class="layui-row layui-col-space10 layui-this layadmin-backlog" id="repairData"  style="background: #fff;">
                                <li class="layui-col-xs6" >
                                    <div class="layadmin-backlog-body">
                                        <h3>电力报修</h3>
                                        <div id="repairData-0" onclick="queryRepairInfo(0)">
                                            <div>超时：0</div>
                                            <div>正常：0</div>
                                        </div>
                                    </div>
                                </li>
                                <li class="layui-col-xs6" >
                                    <div class="layadmin-backlog-body">
                                        <h3>供水报修</h3>
                                        <div id="repairData-1" onclick="queryRepairInfo(1)">
                                            <div>超时：0</div>
                                            <div>正常：0</div>
                                        </div>
                                    </div>
                                </li>
                                <li class="layui-col-xs6" >
                                    <div lay-href="#" class="layadmin-backlog-body">
                                        <h3>煤气报修</h3>
                                        <div id="repairData-2" onclick="queryRepairInfo(2)">
                                            <div>超时：0</div>
                                            <div>正常：0</div>
                                        </div>
                                    </div>
                                </li>
                                <li class="layui-col-xs6" >
                                    <div href="javascript:;"  class="layadmin-backlog-body">
                                        <h3>房屋维修</h3>
                                        <div id="repairData-3" onclick="queryRepairInfo(3)">
                                            <div>超时：0</div>
                                            <div>正常：0</div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md5">
                    <div class="layuiadmin-card-text">
                        <div class="layui-text-top"><i class="layui-icon layui-icon-upload-circle"></i>报修状态统计</div>
                        <div id="communityRepairs" style="width: 600px;height: 280px"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="table" style="display: none">
        <table id="jqGrid"></table>
        <div id="jqGridPager"></div>
    </div>
</body>
<script src="${request.contextPath}/statics/plugins/echarts/echarts.min.js"></script>
<!--<script src="${request.contextPath}/statics/plugins/layui/layui.js"></script>-->
<script>
    var communityRepairs,repairsType;
    let companyId;
    let communityName;
    let layDate;
    let first=true;
    var seriesLabel = {
        normal: {
            show: true,
            textBorderColor: '#333',
            textBorderWidth: 2
        }
    };
    $(function(){
         companyId = $(window.parent.document.getElementById('companyId')).val();
         let companyNames = $(window.parent.document.getElementById('companyName')).val();
         $("#companyNames").text(companyNames);
        ajaxFun("sys/dashBoard/getCompanyRepairStatistic",{"companyId":companyId},getCompanyStatistics);
        communityRepairs = echarts.init(document.getElementById('communityRepairs'));
        communityRepairsSta();
        layDate = layui.laydate;
        //获取系统前一个月的时间
        let nowdate = new Date();
        nowdate.setMonth(nowdate.getMonth()-1);
        let y = nowdate.getFullYear();
        let m = nowdate.getMonth()+1;
        let d = nowdate.getDate();
        if (m<10){
            m = "0"+m;
        }
        let formatwdate = y+'-'+m+'-'+d;


        //常规用法
        layDate.render({
            elem: '#startTime',
            done: function(value, date, endDate){
                console.log(value); //得到日期生成的值，如：2017-08-18
                queryCommunityData();
            },
            value:formatwdate, //设置开始时间为当前时间
        });
        layDate.render({
            elem: '#endTime',
            value:new Date(),
            done: function(value, date, endDate){
                console.log(value); //得到日期生成的值，如：2017-08-18
                queryCommunityData();
            }
        });
    });


    function communityRepairsSta() {
        var option = {

            legend: {
                data: ['已提交', '待处理', '已完成']
            },
            xAxis: {
                type: 'value',
                name: '条数',
                axisLabel: {
                    formatter: '{value}'
                }
            },
            yAxis: {
                type: 'category',
                inverse: true,
                data: ['状态'],

            },
            series: [
                {
                    name: '已提交',
                    type: 'bar',
                    data: [0],
                    label: seriesLabel
                },
                {
                    name: '待处理',
                    type: 'bar',
                    label: seriesLabel,
                    data: [0]
                },
                {
                    name: '已完成',
                    type: 'bar',
                    label: seriesLabel,
                    data: [0]
                }
            ]
        };
        communityRepairs.setOption(option);
    }

    var communityRepairsFun=function (result) {
        var yData=new Array();
        if (result.respCode!= "1001") {
            if (result.data.length > 0) {
                $.each(result.data, function (index, item) {
                    if (item.status == '0') {
                        yData.push({
                            name: '已提交',
                            type: 'bar',
                            data: [item.number],
                            label: seriesLabel
                        });
                    }
                    if (item.status == '1') {
                        yData.push({
                            name: '待处理',
                            type: 'bar',
                            label: seriesLabel,
                            data: [item.number]
                        });
                    }
                    if (item.status == '2') {
                        yData.push({
                            name: '已完成',
                            type: 'bar',
                            label: seriesLabel,
                            data: [item.number]
                        });

                    }

                });
            } else {
                yData = [
                    {
                        name: '已提交',
                        type: 'bar',
                        data: [0],
                        label: seriesLabel
                    },
                    {
                        name: '待处理',
                        type: 'bar',
                        label: seriesLabel,
                        data: [0]
                    },
                    {
                        name: '已完成',
                        type: 'bar',
                        label: seriesLabel,
                        data: [0]
                    }
                ]
            }
            communityRepairs.setOption({series: yData});
        }
    };
    var getLoginTimes= function (result) {
        $("#loginTimes").text("登录次数:"+result.data.logintime);
    };

    let getCompanyStatistics=function (result) {
        let communityText='';

        $.each(result.data,function (index,item) {
            let content='';
            let communityId;
            let households;
            $.each(item,function (k,m) {
                communityId = m.communityId;
                households = m.households;
                if (m.repairsName){
                    content += m.repairsName +':'+m.number+'</br>'
                }
            })
            communityText +=' <li class="layui-col-xs4" onclick="getStatistics('+communityId+',\''+index+'\''+','+households+')">' +
                '                    <div  class="layadmin-backlog-body">' +
                '                        <h3>社区：'+index+'</h3>' +
                                         '<div style="float: right;margin-top: -35px;">今日数据</div>'+
                '                        <p><cite>'+content+'</cite></p>' +
                '                    </div>' +
                '                </li>';
        });
        $("#communityContent").html(communityText);

    }
    function getStatistics(id,name,households) {
        $("#communityText").css("display","block");
        $("#companyText").css("display","none");
        $("#communityName").text(name);
        $("#communityId").val(id);
        $("#communityHouse").text("小区户数:"+households);

        ajaxFun("sys/dashBoard/loginTimesByCommunityId",{"communityId": id},getLoginTimes);
        ajaxFun("sys/dashBoard/loginTimesByCommunityId",{"communityId": id},getLoginTimes);
        queryCommunityData();
    }

    function queryCommunityData() {
        let startTime = $("#startTime").val();
        let endTime = $("#endTime").val();
        if(endTime<startTime){
            layer.msg("查询时间错误");
            return;
        }
        ajaxFun("sys/dashBoard/staticRepairsByStatus",{"communityId": $("#communityId").val(),startTime:startTime,endTime:endTime},communityRepairsFun);
        ajaxFun("sys/dashBoard/getRepairInfoByTime",{"communityId": $("#communityId").val(),startTime:startTime,endTime:endTime},getRepairInfoByTime);
    }

    function calBack() {
        $("#communityText").css("display","none");
        $("#companyText").css("display","block");
    }

    function ajaxFun(url,data,resFun) {
        $.ajax({
            type: "POST",
            url: baseURL + url,
            datType: "JSON",
            data: data,
            success: function (result) {
                resFun(result);
            }
        });
    }

    let getRepairInfoByTime = function(result) {
        for (let i=0;i<4;i++){
            $("#repairData-"+i).html(' <div>超时：0</div>' + '<div>正常：0</div>');
        }
        $.each(result.data,function (index,item) {
            let normal = 0;
            let overTime =0;
            $.each(item,function (j,k) {
                if (k.overtime=true){
                    overTime ++;
                }else {
                    normal++;
                }
            });
            $("#repairData-"+index).html(' <div>超时：'+overTime+'</div>' + '<div>正常：'+normal+'</div>');
        });
    }

    function queryRepairInfo(repairsType) {
        let startTime = $("#startTime").val();
        let endTime = $("#endTime").val();
        let communityId =  $("#communityId").val();
        let queryCondition = {'startTime': startTime+" 00:00:00",endTime:endTime+" 23:59:59",communityId:communityId,repairsType:repairsType};

        layer.open({
            type: 1,
            title :'报修信息',
            area: ['900px', '400px'],
            offset: 'auto',
            fixed: false, //不固定
            shadeClose:true,
            maxmin: true,
            content: $("#table")
        });
        if (first){
            first=false;
            queryPage(queryCondition);
        }else {
            getPage(queryCondition);
        }


    }
    function getPage(queryCondition) {

        var page = $("#jqGrid").jqGrid('getGridParam','page');
        $("#jqGrid").jqGrid('setGridParam',{
            postData:queryCondition,
            page:page
        }).trigger("reloadGrid");
    }
    function  queryPage(queryCondition) {
        $("#jqGrid").jqGrid({
            url: baseURL + 'mobile/repairs/findRepairs',
            datatype: "json",
            mtype:"POST",
            postData:queryCondition,
            colModel: [
                { label: 'id', name: 'id', index: "id",  key: true,hidden:true },
                { label: '业主', name: 'userRealName',align:'center'},
                { label: '业主手机', name: 'userPhone',align:'center'},
                { label: '描述', name: 'detail',align:'center' },
                { label: '状态', name: 'status',align:'center' },
                { label: '提交时间', name: 'createTime',align:'center'},
                { label: '维修类型', name: 'repairsType',align:'center'}
            ],
            viewrecords: true,
            height: 385,
            rowNum: 10,
            rowList : [10,30,50],
            rownumbers: true,
            rownumWidth: 25,
            autowidth:true,
            multiselect: true,
            pager: "#jqGridPager",
            jsonReader : {
                root: "data.list",
                page: "data.currPage",
                total: "data.totalPage",
                records: "page.totalCount"
            },
            prmNames : {
                page:"data",
                rows:"limit",
                order: "order"
            },
            gridComplete:function(){
                //隐藏grid底部滚动条
                $("#jqGrid").closest(".ui-jqgrid-bdiv").css({ "overflow-x" : "hidden" });
            }
        });
    }
</script>
</html>