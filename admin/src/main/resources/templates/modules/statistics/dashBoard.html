<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <#include "/header.html">
        <link rel="stylesheet" href="${request.contextPath}/statics/plugins/layui/css/layui.css">
        <style>
            ::-webkit-scrollbar{width:0px;height:0px;}
            .layadmin-backlog .layadmin-backlog-body {
                display: block;
                padding: 10px 15px;
                background-color: #f8f8f8;
                color: #999;
                border-radius: 2px;
                transition: all .3s;
                -webkit-transition: all .3s;
                height: 125px;
            }
            .layadmin-backlog-body h3 {
                padding-bottom: 10px;
                font-size: 21px;
                color: #009688;
                font-weight: 300;
            }
            .layadmin-backlog-body p cite {
                font-style: normal;
                font-size: 16px;
                color: #000;
            }

            .layui-col-xs4 {
                padding: 20px;
            }

            .layui-form-label {
                width: 90px;
            }

            #LAY-component-grid-mobile-pc .layui-card-body {
                display: flex;
                justify-content: center;
                flex-direction: column;
                text-align: center;
                height: 200px;
            }

            html {
                background-color: #f2f2f2;
                color: #666;
            }
        </style>
</head>
<body>
    <div class="layui-card layadmin-backlog" id="companyText">
        <div class="layui-card-header" style="border-bottom:5px solid #F6F6E5;">
            <h2 style="text-align: center; margin: 10px;font-size: 33px;" id="companyNames"> </h2>
        </div>
        <div class="layui-card-body" style="background: #63df9e61;top:27px;">
            <ul class="layui-row layui-col-space10 layui-this" id="communityContent">
            </ul>
        </div>
    </div>
    <div class="layui-card" id="communityText" style="display: none;">
        <div class="layui-card-header">
            <div class="layui-a-tips">
                <h2 id="communityName" style="text-align: center; margin: 20px;font-size: 41px;"> </h2>

                <div class="layui-col-sm3" style="float: right;margin-top: -65px;">
                    <button class="layui-btn layui-btn-danger" onclick="calBack();">返回</button>
                </div>
            </div>
        </div>
        <div class="layui-card-body">
            <div class="layui-col-sm2">
                <blockquote class="layui-elem-quote" id="communityHouse">小区户数:-</blockquote>
            </div>
            <div class="layui-col-sm2">
                <blockquote class="layui-elem-quote" id="loginTimes">登录次数:-</blockquote>
            </div>
            <div class="layui-col-sm2">
                <blockquote class="layui-elem-quote" id="ljbx">累计报修:</blockquote>
            </div>
            <div class="layui-col-sm2">
                <div id="hpl" style="width: 200px;height: 150px;"></div>

            </div>
            <div class="layui-col-sm2">
                <div id="bxbl" style="width: 300px;height: 150px;"></div>
            </div>
        </div>
        <div class=" layui-fluid" id="LAY-component-grid-mobile-pc">
            <div class="layui-row layui-col-space10">
                <div class="layui-col-xs6 layui-col-md6">
                    <!-- 填充内容 -->
                    <div class="layui-card">
                        <div class="layui-card-header">报修待办事项</div>
                        <div class="layui-card-body">

                        </div>
                    </div>
                </div>
                <div class="layui-col-xs6 layui-col-md6">
                    <div class="layui-card">
                        <div class="layui-card-header">热门家事讨论</div>
                        <div class="layui-card-body">
                            <table class="layui-table">
                                <thead>
                                    <tr>
                                        <th>标题</th>
                                        <th>内容</th>
                                    </tr>
                                </thead>
                                <tbody id="hotArticle" style="height: 200px;overflow:auto;">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs6 layui-col-md8">
                    <div class="layui-card">
                        <div class="layui-card-header">报修列表</div>
                        <div class="layui-card-body" id="table">
                            <table id="jqGrid"></table>
                            <div id="jqGridPager"></div>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs6 layui-col-md4">
                    <div class="layui-card">
                        <div class="layui-card-header">维修人员通讯录</div>
                        <div class="layui-card-body">
                            <table class="layui-table" lay-even="" lay-skin="nob">
                                <colgroup>
                                    <col width="100">
                                    <col width="200">
                                </colgroup>
                                <thead>
                                <tr>
                                    <th>姓名</th>
                                    <th>电话</th>
                                </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>贤心</td>
                                        <td>汉族</td>

                                    </tr>
                                    <tr>
                                        <td>张爱玲</td>
                                        <td>汉族</td>

                                    </tr>
                                    <tr>
                                        <td>Helen Keller</td>
                                        <td>拉丁美裔</td>

                                    </tr>
                                    <tr>
                                        <td>岳飞</td>
                                        <td>汉族</td>

                                    </tr>
                                    <tr>
                                        <td>孟子</td>
                                        <td>华夏族（汉族）</td>

                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

</body>
<script src="${request.contextPath}/statics/plugins/echarts/echarts.min.js"></script>
<!--<script src="${request.contextPath}/statics/plugins/layui/layui.js"></script>-->
<script>
    var communityRepairs, repairsType;
    let companyId;
    let communityName;
    let layDate;
    let first = true;
    let hpl = echarts.init(document.getElementById('hpl'));
    let bxbl = echarts.init(document.getElementById('bxbl'));

    $(function () {
        companyId = $(window.parent.document.getElementById('companyId')).val();
        let companyNames = $(window.parent.document.getElementById('companyName')).val();
        $("#companyNames").text(companyNames);
        ajaxFun("sys/dashBoard/getCompanyRepairStatistic", {"companyId": companyId}, getCompanyStatistics);
        layDate = layui.laydate;

    });


    var getLoginTimes= function (result) {
        $("#loginTimes").text("登录次数:"+result.data.logintime);
    };

    let getCompanyStatistics=function (result) {
        let communityText='';

        $.each(result.data,function (index,item) {
            let content='';
            let communityId;
            let households;
            $.each(item,function (k,m) {
                communityId = m.communityId;
                households = m.households;
                if (m.repairsName){
                    content += m.repairsName +':'+m.number+'</br>'
                }
            })
            communityText +=' <li class="layui-col-xs4" onclick="getStatistics('+communityId+',\''+index+'\''+','+households+')">' +
                '                    <div  class="layadmin-backlog-body">' +
                '                        <h3>社区：'+index+'</h3>' +
                                         '<div style="float: right;margin-top: -35px;">今日数据</div>'+
                '                        <p><cite>'+content+'</cite></p>' +
                '                    </div>' +
                '                </li>';
        });
        $("#communityContent").html(communityText);

    }
    function getStatistics(id,name,households) {
        $("#communityText").css("display","block");
        $("#companyText").css("display","none");
        $("#communityName").text(name);
        $("#communityId").val(id);
        $("#communityHouse").text("小区户数:"+households);
        let communityhtml = "${request.contextPath}/companyIndex.html?communityId="+$('#communityId').val();
        $("#communityhtml").attr("href",communityhtml);
        ajaxFun("sys/dashBoard/loginTimesByCommunityId",{"communityId": id},getLoginTimes);
        queryCommunityData();
        bxblEcharts();
        queryPage({"communityId": id});

        ajaxFun("/mobile/article/queryHotArticle",{"communityId": id,"queryType":"5","type":"community"},queryHotArticle);
    }

    function queryCommunityData() {
        let option = {
            legend: {
                orient: 'vertical',
                left: 10,
                data: ['差评', '中评', '好评']
            },
            series: [
                {
                    name: '访问来源',
                    type: 'pie',
                    radius: ['30%', '60%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '30',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: [
                        {name: "差评", value: 16850}, {name: "中评", value: 69013}, {name: "好评", value: 80003}
                    ]
                }
            ]
        };
        hpl.setOption(option)
    }

    function bxblEcharts() {
        let option = {
            legend: {
                orient: 'vertical',
                left: 10,
                data: ['电力报修', '供水报修', '煤气报修', '房屋报修']
            },
            series: [
                {

                    type: 'pie',
                    radius: '55%',
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '30',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: [
                        {name: "电力报修", value: 16850},
                        {name: "供水报修", value: 69013},
                        {name: "煤气报修", value: 80003},
                        {name: "房屋报修", value: 70003}
                    ]
                }
            ]
        };
        bxbl.setOption(option)
    }

   let queryHotArticle = function (result) {
        let  hotArticle = "";
        $.each(result.data,function (index,item) {
           if (index<5){
               let title = item.title;
               let content = item.content;
               if (title.length>10){
                   title = title.substring(0,10)+"...";
               }
               if (content.length>15){
                   content = content.substring(0,20)+"...";
               }
               hotArticle += " <tr> <td>"+title+"</td><td>"+content+"</td> </tr>"
           }
        });
        console.info(result.data);
        $("#hotArticle").html(hotArticle);
   }

    function calBack() {
        $("#communityText").css("display", "none");
        $("#companyText").css("display", "block");
    }

    function ajaxFun(url, data, resFun) {
        $.ajax({
            type: "POST",
            url: baseURL + url,
            datType: "JSON",
            data: data,
            success: function (result) {
                resFun(result);
            }
        });
    }




    function getPage(queryCondition) {

        var page = $("#jqGrid").jqGrid('getGridParam','page');
        $("#jqGrid").jqGrid('setGridParam',{
            postData:queryCondition,
            page:page
        }).trigger("reloadGrid");
    }
    function  queryPage(queryCondition) {
        $("#jqGrid").jqGrid({
            url: baseURL + 'mobile/repairs/findRepairs',
            datatype: "json",
            mtype:"POST",
            postData:queryCondition,
            colModel: [
                { label: 'id', name: 'id', index: "id",  key: true,hidden:true },
                { label: '业主', name: 'userRealName',align:'center'},
                { label: '业主手机', name: 'userPhone',align:'center'},
                { label: '描述', name: 'detail',align:'center' },
                { label: '状态', name: 'status',align:'center' },
                { label: '提交时间', name: 'createTime',align:'center'},
                { label: '维修类型', name: 'repairsType',align:'center'}
            ],
            viewrecords: true,
            height: 159,
            rowNum: 10,
            rowList : [10,30,50],
            rownumbers: true,
            rownumWidth: 25,
            autowidth:true,
            multiselect: true,
            pager: "#jqGridPager",
            jsonReader : {
                root: "data.list",
                page: "data.currPage",
                total: "data.totalPage",
                records: "page.totalCount"
            },
            prmNames : {
                page:"data",
                rows:"limit",
                order: "order"
            },
            gridComplete:function(){
                //隐藏grid底部滚动条
                $("#jqGrid").closest(".ui-jqgrid-bdiv").css({ "overflow-x" : "hidden" });
            }
        });
    }
</script>
</html>