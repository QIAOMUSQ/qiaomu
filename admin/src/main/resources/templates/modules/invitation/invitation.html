<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <#include "/header.html">
    <link rel="stylesheet" href="${request.contextPath}/statics/plugins/layui/css/layui.css">
    <link rel="stylesheet" href="${request.contextPath}/statics/plugins/diyUpload/webuploader.css">
    <style>
        .layui-btn {
            display: inline-block;
            height: 30px;
            line-height: 30px;
            padding: 0 18px;
            background-color: #009688;
            color: #fff;
            white-space: nowrap;
            text-align: center;
            font-size: 14px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            margin: 5px 10px;
        }
        .webuploader-container { position: relative; }
        .webuploader-element-invisible { position: absolute !important;  clip: rect(1px 1px 1px 1px); /* IE6, IE7 */  clip: rect(1px,1px,1px,1px); }
        .webuploader-pick { position: relative;  display: inline-block;  cursor: pointer;  background: #00b7ee;  padding: 10px 15px;  color: #fff;  text-align: center;  border-radius: 3px;  overflow: hidden; }
        .webuploader-pick-hover { background: #00a2d4; }
        .webuploader-pick-disable { opacity: 0.6;  pointer-events:none; }
        ::-webkit-scrollbar {
            display: none;
        }
        .layui-form-selected dl {
            display: block;
            z-index: 99999;
            background: #abe4b3;
        }

    </style>
</head>
<body>
<div >
    <div id="main">
        <div class="grid-btn">
            <div class="form-group col-sm-2">
                <input type="text" class="form-control" id="titleName" placeholder="名称">
            </div>
            <#if shiro.hasPermission("invitation:select")>
                <a class="btn btn-default" onclick="reload()">查询</a>
            </#if>
            <#if shiro.hasPermission("invitation:add")>
                <a class="btn btn-primary" onclick="add()" ><i class="fa fa-plus"></i>&nbsp;新增</a>
            </#if>
             <a class="btn btn-primary" onclick="edit()" ><i class="fa fa-edit"></i>&nbsp;修改</a>
            <#if shiro.hasPermission("invitation:delete")>
                <a class="btn btn-primary" onclick="deleteById()"><i class="fa fa-trash-o"></i>&nbsp;删除</a>
            </#if>
        </div>
        <table id="jqGrid"></table>
        <div id="jqGridPager"></div>
    </div>
    <div id="add" style="display: none;">
        <div class="layui-card">
            <div class="layui-card-header">
                <button class="layui-btn" id="submitData" style="right: 18px;position: absolute;" onclick="submitData()" lay-filter="component-form-demo1">立即提交</button>
                <button class="layui-btn layui-btn-primary" onclick="rollback()" style="position: absolute;right: 136px;">返回</button>
            </div>
            <div class="layui-card-body" style="padding: 15px;">
                <form class="layui-form" id="form" action="" lay-filter="component-form-group">
                    <input id="dataId" name="id" style="display: none">
                    <div class="layui-form-item">
                        <div class="layui-col-md6">
                            <label class="layui-form-label">标题：</label>
                            <div class="layui-col-md7">
                                <input type="text" id="title" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-col-md6">
                            <label class="layui-form-label">社区</label>
                            <div class="layui-col-md7" id="communityId" name="communityId" lay-filter="communityId"></div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div id="contentText"  class="layui-col-md12"></div>
                    </div>
                    <div class="layui-form-item" id="layui-form-item">
                        <div class="layui-input-block">
                            <div id="upImg_names" style="top:10px;width: 120px;">选择图片</div>
                            <div id="uploadFiles" style="position: absolute;top: 61px;">
                                <div id="picContents"></div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
</body>
<!--<script src="${request.contextPath}/statics/plugins/diyUpload/js/diyUpload.js" type="text/javascript"></script>-->
<script src="${request.contextPath}/statics/plugins/wangEditor/wangEditor.js" type="text/javascript"></script>
<script src="${request.contextPath}/statics/plugins/diyUpload/js/webuploader.min.js" type="text/javascript"></script>
<script src="${request.contextPath}/statics/plugins/diyUpload/js/webuploadpic.js" type="text/javascript"></script>
<script src="${request.contextPath}/statics/plugins/layui/layui.js"></script>
<script src="${request.contextPath}/statics/plugins/layui/lay/selectPlus.js"></script>
<script>
    var editor2;
    var selectPlus;
    var communityId;
    $(function () {
        var E = window.wangEditor;
        editor2 = new E('#contentText');
        // 自定义菜单配置
        editor2.customConfig.menus = [
            'head',  // 标题
            'bold',  // 粗体
            'fontSize',  // 字号
            'fontName',  // 字体
            'italic',  // 斜体
            'underline',  // 下划线
            'foreColor',  // 文字颜色
            'backColor',  // 背景颜色
            'justify'  // 对齐方式
        ]
        editor2.create();
        $("#jqGrid").jqGrid({
            url: baseURL + 'mobile/invitation/pageList',
            datatype: "json",
            mtype:"POST",
            postData:{'communityId': window.parent.$("#communityId").val(),
                        'communityIds':window.parent.$("#communityIds").val()},
            colModel: [
                { label: 'id', name: 'id', index: "id", width: 45, key: true,hidden:true },
                { label: '标题', name: 'title',  width: 45 },
                { label: '社区', name: 'communityName', width: 75 },
                { label: '图片', name: 'imgJson', width: 90 ,
                    editable:true,
                    formatter:function (cellvalue, options, rowObject) {
                        var temp ="";
                        $.each(JSON.parse(cellvalue),function (index,item) {
                             temp += '<img style="height: 30px;width: 30px;" src="'+item.path+'"/>'
                        });
                        return temp;
                    }
                },
                { label: '创建时间', name: 'createTime', width: 100 },
                { label: '详情', width: 40,
                    formatter:function (cellvalue, options, rowObject) {
                        return "<bnttom class='layui-btn' onclick='getById("+rowObject.id+")'>详情</bnttom>"
                } }
            ],
            viewrecords: true,
            height: 385,
            rowNum: 10,
            rowList : [10,30,50],
            rownumbers: true,
            rownumWidth: 25,
            autowidth:true,
            multiselect: true,
            pager: "#jqGridPager",
            jsonReader : {
                root: "page.list",
                page: "page.currPage",
                total: "page.totalPage",
                records: "page.totalCount"
            },
            prmNames : {
                page:"page",
                rows:"limit",
                order: "order"
            },
            gridComplete:function(){
                //隐藏grid底部滚动条
                $("#jqGrid").closest(".ui-jqgrid-bdiv").css({ "overflow-x" : "hidden" });
            }
        });
    });


    function reload() {
        var page = $("#jqGrid").jqGrid('getGridParam','page');
        $("#jqGrid").jqGrid('setGridParam',{
            postData:{'title': $("#titleName").val(),'communityId': window.parent.$("#communityId").val()},
            page:page
        }).trigger("reloadGrid");
    }

    function rollback() {
        $("#communityId").html("");
        $("#main").css("display","block");
        $("#add").css("display","none");
        editor2.txt.html('<p></p>');
        $("#picContents").html("");
        $("#layui-form-item").html("");
        $("#title").val("");
        reload();
    }

    function add() {
        $("#main").css("display","none");
        $("#add").css("display","block");
        $("#submitData").css("display","block");
        $("#upImg_names").css("display","block");
        $("#layui-form-item").html('<div class="layui-input-block">\n' +
            '                            <div id="upImg_names" style="top:10px;width: 120px;">选择图片</div>\n' +
            '                            <div id="uploadFiles" style="position: absolute;top: 61px;">\n' +
            '                                <div id="picContents"></div>\n' +
            '                            </div>\n' +
            '                        </div>');
        upload('#upImg_names','#picContents','imgJson',setPics);
        // 单选
        selectPlus = layui.selectPlus;
         communityId = selectPlus.render({
            el: '#communityId',
            url: baseURL + "communityMessage/getAllCommunity",
            parseData: function (res) {
                return res.data;
            },
            type: "radio",
            valueName: "name",
            label: ["name"]
        });
    }
    function edit() {
        let id = getSelectedRow();
        if(id == undefined){
            return ;
        }
        $("#main").css("display","none");
        $("#add").css("display","block");
        $("#submitData").css("display","block");
        $("#upImg_names").css("display","block");
        $("#layui-form-item").html('<div class="layui-input-block">\n' +
            '                            <div id="upImg_names" style="top:10px;width: 120px;">选择图片</div>\n' +
            '                            <div id="uploadFiles" style="position: absolute;top: 61px;">\n' +
            '                                <div id="picContents"></div>\n' +
            '                            </div>\n' +
            '                        </div>');
        // 单选
        selectPlus = layui.selectPlus;
        upload('#upImg_names','#picContents','imgJson',setPics);

        $.ajax({
            type:"GET",
            url:baseURL + "mobile/invitation/getById",
            datType:"JSON",
            data: {"id":id},
            success:function (result) {
                editor2.txt.html(result.data.content);
                $("#title").val(result.data.title);
                $("#dataId").val(result.data.id);
                // 单选
                communityId = selectPlus.render({
                    el: '#communityId',
                    url: baseURL + "communityMessage/getAllCommunity",
                    parseData: function (res) {
                        return res.data;
                    },
                    type: "radio",
                    valueName: "name",
                    label: ["name"],
                    values: result.data.communityName
                });
                $.each(JSON.parse(result.data.imgJson),function (index,item) {
                    let filedIsplayStr = "<div id='picContainerDiv"+index+"' class=' ui-form-uploadfilediv' style='float: left;'>"+
                                            "<div id='picdiv"+index+"' class='picdiv'>"+
                                            "<img src=" + item.path.substring(0,item.path.indexOf("outapp/image"))+"welfare/sysFile/showPicForMany?name="+item.path.substring(item.path.lastIndexOf("/")+1,item.length) + " width='160px' height='120px' />" +
                                            "<p class='diyControl'>"+
                                                    "<span class='diyCancel' onclick='clickTest($(this))'><i></i></span>"+
                                                "</p>"+
                                                "<div class='pics-overlay'>"+
                                                    "<a class='picDivClose close'><i class='iconfont icon-close'></i></a><br>"+
                                                "</div>"+
                                                "<div class='picDivSortNo'>"+
                                                    "<input type='hidden' name='imgJson"+"_"+index+"' value='" + item.path + "'>" +
                                                    "<input type='hidden' class='fileName' name='fileName' value='"+item.path.substring(item.path.lastIndexOf("/")+1,item.path.length)+"'>"+
                                                "</div>"+
                                            "</div>";

                    $("#picContents").append(filedIsplayStr);
                })
            }
        });
    }

    function clickTest(doc) {
        let ob = doc.parents("div.ui-form-uploadfilediv");
        ob.remove();
    }
    function getById(id) {
        $("#main").css("display","none");
        $("#upImg_names").css("display","none");
        $("#add").css("display","block");
        $("#layui-form-item").html('<div class="layui-input-block">\n' +
            '                            <div id="upImg_names" style="top:10px;width: 120px;">选择图片</div>\n' +
            '                            <div id="uploadFiles" style="position: absolute;top: 61px;">\n' +
            '                                <div id="picContents"></div>\n' +
            '                            </div>\n' +
            '                        </div>');
        selectPlus = layui.selectPlus;
        $.ajax({
            type:"GET",
            url:baseURL + "mobile/invitation/getById",
            datType:"JSON",
            data: {"id":id},
            success:function (result) {
                $("#submitData").css("display","none");
                editor2.txt.html(result.data.content);
                $("#title").val(result.data.title);
                // 单选
                communityId = selectPlus.render({
                    el: '#communityId',
                    url: baseURL + "communityMessage/getAllCommunity",
                    parseData: function (res) {
                        return res.data;
                    },
                    type: "radio",
                    valueName: "name",
                    label: ["name"],
                    values: result.data.communityName
                });
                //$("#communityId").css("disabled","disabled")
                $('select').attr('disabled', 'disabled');
                $.each(JSON.parse(result.data.imgJson),function (index,item) {
                    $("#picContents").append('<img style="width: 120px;height: 80px;" src="'+item.path+'"/>');
                })
            }
        });


    }

    function deleteById (){
        var ids = getSelectedRows();
        if(ids == null){
            return ;
        }
        confirm('确定要删除选中的记录？', function(){
            $.ajax({
                type: "POST",
                url: baseURL + "mobile/invitation/delete",
                contentType: "application/json",
                data: JSON.stringify(ids),
                success: function(result){
                    alert('删除成功', function(){
                        reload();
                    });
                }
            });
        });
    }

   function submitData() {
       let obj = communityId.getChecked();
       let html = editor2.txt.html();
       let nameJson = $("#form").serialize().split("&");
       let imgJson = new Array();
       $.each(nameJson,function (index,item) {
           if(item.indexOf("imgJson")>=0){
               imgJson.push({name:item.split("=")[0], path:decodeURIComponent(item.split("=")[1],true)});
           }
       });
       let test2Val = $("#test2").val();

       $.ajax({
           type:"POST",
           url:baseURL + "mobile/invitation/save",
           data: {"communityId":obj.data[0].id,
               "imgJson":JSON.stringify(imgJson),
                "title":$("#title").val(),
                "id":$("#dataId").val(),
                "contentHtml":html},
           success:function (result) {
               if(result.respCode =="1000"){
                   alert(result.data);
                   rollback();
               }else {
                   alert(result.data);
               }

           }
       });
   }

</script>
</html>