<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.qiaomu.modules.workflow.dao.RepairsInfoDao">
    <resultMap id="statusNumber" type="java.util.HashMap">
        <result property="status" column="status"/>
        <result property="number" column="number"/>
    </resultMap>
    <resultMap id="repairsTypeNumber" type="java.util.HashMap">
        <result property="repairs_type" column="repairs_type"/>
        <result property="number" column="number"/>
    </resultMap>

    <select id="findRepairs" resultType="com.qiaomu.modules.workflow.entity.RepairsInfo">
        SELECT
            r.id,
            r.user_id,
            r.create_time,
            r.detail,
            r.repairs_id,
            r.repairs_type,
            r.`status`,
            u.hand_img_id AS imgId
        FROM
            yw_repairs_info r
        LEFT JOIN sys_user u ON r.user_id = u.user_id
        <where>
            1=1
            <if test="userId !=null">
                and user_id =#{userId}
            </if>
            <if test="communityId !=null">
                and community_id =#{communityId}
            </if>
            <if test="repairsType !=null and repairsType !='' ">
                and repairs_type =#{repairsType}
            </if>
            <if test="status !=null and status != '' ">
                and status =#{status}
            </if>
            <if test="repairsId !=null">
                and repairs_id =#{repairsId}
            </if>
        </where>
        ORDER BY r.create_time DESC
    </select>

    <select id="selectPages" resultType="com.qiaomu.modules.workflow.entity.RepairsInfo" >
        SELECT
            r.id,
            r.user_id,
            r.community_id,
            r.create_time,
            r.detail,
            r.repairs_id,
            r.repairs_type,
            r.`status`,
            u.hand_img_id AS imgId,
            u.real_name as userRealName,
            u.username as userPhone
        FROM
            yw_repairs_info r
            LEFT JOIN sys_user u ON r.user_id = u.user_id
        <where>
            1=1
            <if test="userId !=null">
                and r.user_id =#{userId}
            </if>
            <if test="communityId !=null">
                and r.community_id =#{communityId}
            </if>
            <if test="repairsType !=null and repairsType !='' ">
                and r.repairs_type =#{repairsType}
            </if>
            <if test="queryType !=null">
                and r.status &lt; 2
            </if>
            <if test="status !=null">
                and r.status = #{status}
            </if>
            <if test="communityIds !=null">
                and r.community_id in
                <foreach item="communityId" collection="communityIds" open="(" separator="," close=")">
                    #{communityId}
                </foreach>
            </if>
            <if test="repairsId !=null">
                and r.repairs_id =#{repairsId}
            </if>
        </where>
        ORDER BY r.create_time DESC
    </select>
    <select id="findRepairsById" parameterType="long" resultType="com.qiaomu.modules.workflow.entity.RepairsInfo">
       SELECT
            r.id,
            r.user_id,
            r.community_id,
            r.user_opinion,
            r.detail,
            r.create_time,
            r.repairs_time,
            r.location,
            r.picture,
            r.service_date,
            r.repairs_type,
            r.star_type,
            r.repairs_id,
            r.repairs_type,
            r.apportion_time,
            r.linger_time,
            r.`status`,
            u.hand_img_id AS imgId,
            u.real_name as userRealName,
            u.username as userPhone
        FROM
            yw_repairs_info r
        LEFT JOIN sys_user u ON r.user_id = u.user_id
        where r.id = #{id}
    </select>
    <select id="selectPagesByRepairs" resultType="com.qiaomu.modules.workflow.entity.RepairsInfo">
        SELECT
            i.id,
            i.user_id,
            i.community_id,
            i.create_time,
            i.detail,
            r.user_id as repairsId,
            i.repairs_type,
            i.`status`,
            s.hand_img_id AS imgId,
            s.real_name AS userRealName,
            s.username AS userPhone
        FROM
          yw_repairs_info i
        LEFT JOIN yw_user_repairs r ON i.id = r.repairs_id
        LEFT JOIN sys_user s ON s.user_id = i.user_id
        <where>
            1=1
            <if test="repairsType !=null and repairsType !='' ">
                and i.repairs_type =#{repairsType}
            </if>
            <if test="queryType !=null">
                and r.status &lt; 2
            </if>
            <if test="status !=null and status != '' ">
                and i.status =#{status}
            </if>
            <if test="communityIds !=null">
                and i.community_id in
                <foreach item="communityId" collection="communityIds" open="(" separator="," close=")">
                    #{communityId}
                </foreach>
            </if>
            <if test="repairsId !=null">
                and r.user_id =#{repairsId}
            </if>
        </where>
        ORDER BY i.create_time DESC
    </select>

    <select id="staticRepairsByStatus" resultMap="statusNumber"  parameterType="String">
        SELECT count(*) as number,status from yw_repairs_info where community_id = #{community_id} GROUP by status ASC
    </select>

    <select id="staticRepairsByrepairsType" resultMap="repairsTypeNumber"  parameterType="String">
        SELECT count(*) as number,repairs_type from yw_repairs_info where community_id = #{community_id} GROUP by repairs_type ASC
    </select>

    <select id="staticRepairsByAssign"  resultType="com.qiaomu.modules.workflow.entity.RepairsInfo"  parameterType="String">
        SELECT * from yw_repairs_info where  community_id = #{community_id} AND status=1 ORDER by apportion_time ASC
    </select>

</mapper>